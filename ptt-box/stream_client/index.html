<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#16213e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <title>Web„Éà„É©„É≥„Ç∑„Éº„Éê„Éº</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 5px auto;
            padding: 5px;
            background: #1a1a2e;
            color: #eee;
        }
        .container {
            background: #16213e;
            border-radius: 12px;
            padding: 10px 15px;
            text-align: center;
        }
        /* Connection Toggle Button */
        .connection-toggle {
            width: 100%;
            margin: 8px 0;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
            transition: all 0.2s;
        }
        .connection-toggle.disconnected {
            background: #641220 !important;
            color: #f8d7da;
        }
        .connection-toggle.connecting {
            background: #3d405b !important;
            color: #f4f1de;
        }
        .connection-toggle.connected {
            background: #1b4332 !important;
            color: #95d5b2;
        }
        .connection-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .disconnected .connection-indicator { background: #e94560; }
        .connecting .connection-indicator { background: #f4f1de; animation: pulse 1s infinite; }
        .connected .connection-indicator { background: #95d5b2; }
        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.2s;
        }
        button:hover:not(:disabled) {
            background: #ff6b6b;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        button.secondary {
            background: #3d405b;
        }
        button.secondary:hover:not(:disabled) {
            background: #5c5f7e;
        }
        .volume-meter {
            height: 4px;
            background: #0a1628;
            border-radius: 2px;
            overflow: hidden;
        }
        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff87, #60efff);
            width: 0%;
            transition: width 0.05s;
            border-radius: 2px;
        }
        .info {
            margin-top: 20px;
            font-size: 12px;
            color: #888;
        }
        /* PTT Button */
        .ptt-container {
            margin: 10px 0;
        }
        .ptt-button {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: #3d405b;
            border: 5px solid #555;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: all 0.15s;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        .ptt-button:active:not(:disabled),
        .ptt-button.pressing,
        .ptt-button.transmitting {
            background: #e94560;
            border-color: #ff6b6b;
            transform: scale(0.95);
            box-shadow: 0 0 30px rgba(233, 69, 96, 0.5);
        }
        .ptt-button.receiving {
            background: #1b4332;
            border-color: #95d5b2;
        }
        .ptt-button:disabled {
            background: #333;
            border-color: #444;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .ptt-icon {
            font-size: 36px;
            margin-bottom: 5px;
        }
        .ptt-label {
            font-size: 14px;
            font-weight: 500;
        }
        /* Speaker Status */
        .speaker-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: #0f3460;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .speaker-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
        }
        .speaker-indicator.transmitting {
            background: #e94560;
            animation: pulse 1s infinite;
        }
        .speaker-indicator.receiving {
            background: #95d5b2;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            margin-bottom: 8px;
            border-bottom: 2px solid #0f3460;
        }
        .tab-btn {
            flex: 1;
            padding: 8px;
            background: transparent !important;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 14px;
            border-radius: 0;
            margin: 0;
            transition: color 0.2s;
        }
        .tab-btn:hover {
            color: #aaa;
            background: transparent !important;
        }
        .tab-btn.active {
            color: #60efff;
            border-bottom: 2px solid #60efff;
            margin-bottom: -2px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* History List */
        .history-list {
            text-align: left;
            max-height: 500px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .history-item {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: #0f3460;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
            gap: 6px;
        }
        .history-item:hover {
            background: #1a4a7a;
        }
        .history-item.playing {
            background: #1b4332;
        }
        .history-row1 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .history-row2 {
            padding-left: 34px;
        }
        .history-play-icon {
            font-size: 16px;
            color: #888;
            flex-shrink: 0;
            width: 20px;
            text-align: center;
        }
        .history-item.playing .history-play-icon {
            color: #e94560;
        }
        .source-badge {
            font-size: 16px;
            flex-shrink: 0;
        }
        .client-id {
            font-size: 0.75em;
            color: #60efff;
            background: rgba(96, 239, 255, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            flex-shrink: 0;
        }
        .history-datetime {
            font-size: 12px;
            color: #60efff;
        }
        .history-preview {
            font-size: 13px;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-edit-btn {
            padding: 6px 12px;
            background: #3d405b;
            border: none;
            color: #aaa;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            margin-left: auto;
        }
        .history-edit-btn:hover {
            background: #5c5f7e;
            color: #fff;
        }
        .history-empty {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        .history-loading {
            text-align: center;
            color: #888;
            padding: 40px 20px;
        }

        /* Edit Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: #16213e;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #0f3460;
        }
        .modal-title {
            font-size: 16px;
            font-weight: 500;
        }
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }
        .modal-textarea {
            width: 100%;
            height: 300px;
            background: #0a0a15;
            border: 1px solid #0f3460;
            border-radius: 6px;
            color: #eee;
            font-family: monospace;
            font-size: 13px;
            padding: 12px;
            resize: vertical;
        }
        .modal-footer {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            border-top: 1px solid #0f3460;
            justify-content: flex-end;
        }
        .modal-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        .modal-btn-primary {
            background: #60efff;
            color: #1a1a2e;
            border: none;
        }
        .modal-btn-secondary {
            background: #3d405b;
            color: #eee;
            border: none;
        }

        /* Clients Badge */
        .clients-badge {
            padding: 4px 10px;
            background: #1a4a7a;
            border: none;
            border-radius: 4px;
            color: #60efff;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }
        .clients-badge:hover {
            background: #2a5a8a;
        }
        .clients-badge.visible {
            display: inline-block;
        }

        /* Clients Popup */
        .clients-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #16213e;
            border-radius: 12px;
            min-width: 250px;
            max-width: 90%;
            max-height: 60vh;
            z-index: 1001;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .clients-popup.active {
            display: block;
        }
        .clients-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #0f3460;
        }
        .clients-popup-title {
            font-size: 14px;
            font-weight: 500;
        }
        .clients-popup-close {
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .clients-popup-body {
            padding: 8px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .client-item-popup {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
        }
        .client-item-popup:hover {
            background: #0f3460;
        }
        .client-icon {
            font-size: 16px;
        }
        .client-name-popup {
            font-size: 14px;
            color: #eee;
        }
        .no-clients-popup {
            padding: 20px;
            text-align: center;
            color: #888;
            font-size: 14px;
        }
        .clients-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }
        .clients-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('transceiver')">„Éà„É©„É≥„Ç∑„Éº„Éê„Éº</button>
            <button class="tab-btn" onclick="switchTab('history')">Â±•Ê≠¥</button>
        </div>

        <!-- Transceiver Tab -->
        <div id="tab-transceiver" class="tab-content active">
            <!-- Connection Toggle -->
            <button id="connectionToggle" class="connection-toggle disconnected" onclick="toggleConnection()">
                <span class="connection-indicator"></span>
                <span class="connection-text">Êú™Êé•Á∂ö - „Çø„ÉÉ„Éó„ÅßÊé•Á∂ö</span>
            </button>

            <!-- Speaker Status -->
            <div id="speakerStatus" class="speaker-status">
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div id="speakerIndicator" class="speaker-indicator"></div>
                    <span id="speakerName">ÂæÖÊ©ü‰∏≠</span>
                </div>
                <button id="clientsBadge" class="clients-badge" onclick="event.stopPropagation(); showClientsPopup()">0‰∫∫</button>
            </div>

            <!-- Volume Meter -->
            <div class="volume-meter" style="margin-bottom: 15px;">
                <div id="p2pVolumeBar" class="volume-bar"></div>
            </div>

            <!-- PTT Button -->
            <div class="ptt-container">
                <button id="pttBtn" class="ptt-button"
                        onpointerdown="pttStart(event)"
                        onpointerup="pttEnd(event)"
                        onpointercancel="pttEnd(event)"
                        onpointerleave="pttEnd(event)"
                        disabled>
                    <span class="ptt-icon">üéôÔ∏è</span>
                    <span class="ptt-label">Êäº„Åó„Å¶Ë©±„Åô</span>
                </button>
            </div>

            <audio id="audio" autoplay playsinline></audio>

            <div style="margin-top: 12px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 20px;" title="PC„Çπ„Éà„É™„Éº„É†">üîà</span>
                <input type="range" id="volumeSlider" min="0" max="100" value="40"
                       style="flex: 1; height: 8px; cursor: pointer; accent-color: #60efff;"
                       oninput="setVolume(this.value)">
                <span id="volumeValue" style="min-width: 40px; text-align: right;">40%</span>
            </div>

            <div style="margin-top: 8px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 20px;" title="P2PÈü≥Â£∞">üë•</span>
                <input type="range" id="p2pVolumeSlider" min="0" max="100" value="40"
                       style="flex: 1; height: 8px; cursor: pointer; accent-color: #f39c12;"
                       oninput="setP2PVolume(this.value)">
                <span id="p2pVolumeValue" style="min-width: 40px; text-align: right;">40%</span>
            </div>

            <div style="margin-top: 8px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 20px;" title="„Éû„Ç§„ÇØ„Ç≤„Ç§„É≥">üé§</span>
                <input type="range" id="micGainSlider" min="50" max="300" value="100"
                       style="flex: 1; height: 8px; cursor: pointer; accent-color: #27ae60;"
                       oninput="setMicGain(this.value)">
                <span id="micGainValue" style="min-width: 40px; text-align: right;">1.0x</span>
            </div>

            <div style="margin-top: 10px;">
                <button onclick="openSettings()" style="background: #3d405b; padding: 8px 16px; font-size: 14px; width: 100%;">‚öôÔ∏è Ë®≠ÂÆö</button>
            </div>

            <div id="debugButtonContainer" style="margin-top: 10px; display: none;">
                <button onclick="toggleDebug()" style="background: #333; padding: 8px 16px; font-size: 14px; width: 100%;">„Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫</button>
            </div>

            <div id="debug" style="margin-top: 10px; font-size: 12px; color: #aaa; text-align: left; max-height: 200px; overflow-y: auto; background: #0a0a15; padding: 12px; border-radius: 6px; word-break: break-all; display: none;">
            </div>
        </div>

        <!-- History Tab -->
        <div id="tab-history" class="tab-content">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                <button onclick="loadHistory()" style="background: #3d405b; padding: 10px 20px; font-size: 14px;">Êõ¥Êñ∞</button>
                <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 16px;">üîä</span>
                    <input type="range" id="historyVolumeSlider" min="0" max="100" value="40"
                           style="flex: 1; height: 6px; cursor: pointer; accent-color: #60efff;"
                           oninput="setHistoryVolume(this.value)">
                    <span id="historyVolumeValue" style="min-width: 35px; font-size: 12px; text-align: right;">40%</span>
                </div>
            </div>
            <div id="historyList" class="history-list">
                <div class="history-loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
            </div>
            <audio id="historyAudio" style="display: none;" preload="none"></audio>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">SRTÁ∑®ÈõÜ</span>
                <button class="modal-close" onclick="closeEditor()">&times;</button>
            </div>
            <div class="modal-body">
                <audio id="editAudioPlayer" controls preload="none" style="width: 100%; margin-bottom: 15px;"></audio>
                <textarea id="editTextarea" class="modal-textarea"></textarea>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeEditor()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="modal-btn modal-btn-primary" onclick="saveSrt()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <span class="modal-title">Ë®≠ÂÆö</span>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <div style="margin-bottom: 10px; font-weight: 500;">PTT„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Ç≠„Éº</div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div id="pttKeyDisplay" style="flex: 1; padding: 12px; background: #0a0a15; border-radius: 6px; text-align: center; font-family: monospace;">Ctrl+Space</div>
                        <button onclick="startKeyRegistration()" id="registerKeyBtn" style="padding: 12px 20px; background: #3d405b; border: none; color: #eee; border-radius: 6px; cursor: pointer;">ÁôªÈå≤</button>
                    </div>
                    <div id="keyRegistrationHint" style="margin-top: 10px; font-size: 12px; color: #888; display: none;">„Ç≠„Éº„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ...</div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="debugButtonToggle" onchange="toggleDebugButtonVisibility(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>„Éá„Éê„ÉÉ„Ç∞„Éú„Çø„É≥„ÇíË°®Á§∫</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeSettings()">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <!-- Clients Popup -->
    <div id="clientsOverlay" class="clients-overlay" onclick="hideClientsPopup()"></div>
    <div id="clientsPopup" class="clients-popup">
        <div class="clients-popup-header">
            <span class="clients-popup-title">Êé•Á∂ö‰∏≠ (<span id="clientsPopupCount">0</span>)</span>
            <button class="clients-popup-close" onclick="hideClientsPopup()">&times;</button>
        </div>
        <div id="clientsPopupBody" class="clients-popup-body">
            <div class="no-clients-popup">Êé•Á∂ö‰∏≠„ÅÆ„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅØ„ÅÑ„Åæ„Åõ„Çì</div>
        </div>
    </div>

    <script src="js/stream.js"></script>
    <script src="js/history.js"></script>
    <script>
        // Service WorkerÁôªÈå≤
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
